<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>The Eternalblue Story</title>
<meta name=description content="Introduction The story of the eternalblue vulnerability is quite an interesting one as it comes back to the ever-recurring issue of government spying and …"><meta name=keywords content='blog,gokarna,hugo,Cybersecurity'><meta property="og:url" content="https://gabealopez.github.io/posts/eternal-blue/"><meta property="og:type" content="website"><meta property="og:title" content="The Eternalblue Story"><meta property="og:description" content="Introduction The story of the eternalblue vulnerability is quite an interesting one as it comes back to the ever-recurring issue of government spying and …"><meta property="og:image" content="https://gabealopez.github.io/cyberduck"><meta property="og:image:secure_url" content="https://gabealopez.github.io/cyberduck"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="The Eternalblue Story"><meta name=twitter:description content="Introduction The story of the eternalblue vulnerability is quite an interesting one as it comes back to the ever-recurring issue of government spying and …"><meta property="twitter:domain" content="https://gabealopez.github.io/posts/eternal-blue/"><meta property="twitter:url" content="https://gabealopez.github.io/posts/eternal-blue/"><meta name=twitter:image content="https://gabealopez.github.io/cyberduck"><link rel=canonical href=https://gabealopez.github.io/posts/eternal-blue/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://gabealopez.github.io/><img src=/cyberduck alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://gabealopez.github.io/>Gabriel Lopez</a></div><div class=nav-links><div class=nav-link><a href=https://gabealopez.github.io/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://gabealopez.github.io/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://gabealopez.github.io/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://gabealopez.github.io/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/gokarna-theme/gokarna-hugo aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://gabealopez.github.io/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://gabealopez.github.io/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://gabealopez.github.io/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://gabealopez.github.io/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://gabealopez.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/gokarna-theme/gokarna-hugo><span data-feather=github></span></a></li><li class=nav-item><a href=https://gabealopez.github.io/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>The Eternalblue Story</h1><small role=doc-subtitle></small><p class=post-date>November 17, 2024</p><ul class=post-tags><li class=post-tag><a href=https://gabealopez.github.io/tags/cybersecurity>Cybersecurity</a></li></ul></div><div class=post-content><h3 id=introduction>Introduction</h3><p>The story of the eternalblue vulnerability is quite an interesting one as it comes back to the ever-recurring issue of government spying and whether or not the ends justify the means when it comes to government spying for the sake of protection.</p><h3 id=background-info>Background Info</h3><p>Before getting into the events of what happened surrounding the discovery of the eternalblue vulnerability it is important to know what this vulnerability is in the first place. Eternalblue was a vulnerability in the file-sharing service SMB in various Windows operating systems. These operating systems included Windows Vista all the way to Windows Server 2016. This was done by using corroded packets sent to the service which allowed for remote code execution. According to NIST, this was designated with a CVS score of 8.8<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. To put this score into perspective usually anything ranging from a 6-1 is considered minor, 7 is somewhat a concern, and 8-10 is a major problem.</p><p>Now that is just the score. To put the impact of the vulnerability into perspective of how many devices were affected in the image below from Help Net Security shows the number of IP addresses that were affected by the vulnerability<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><p><img src=/cybersecurityPhotos/eternalBlue/ipPic.png alt="Number of IP addresses affected"></p><p>Out of the 8.03m devices, 60k were vulnerable around the world which is a large number that is hard to comprehend. But wait there is more. In the USA alone 1,572 devices were affected by the vulnerability which considering other countries, the USA got off easy as seen in the following graphic from the same Help Net Security:</p><p><img src=/cybersecurityPhotos/eternalBlue/usDevices.png alt="US Devices"></p><p>So overall, we can see that this vulnerability allowed for remote code execution. This means that any person could just get access to a device with an exploit for the vulnerability from any location as long as they could hit the service.</p><p>So in summary the eternalblue vulnerability has affected many of the world&rsquo;s machines.</p><p>If you are interested in the nitty-gritty details of how this vulnerability really works then go through the details section below. If not go <a href=#the-wild-events-leading-up-events-leading-up>here</a>. The link will move you to events leading up to the discovery of the vulnerability, which is the main meat and potatoes of all of this.</p><h3 id=details>Details</h3><p>Most of this explanation comes from a sentinel one page <a href=https://www.sentinelone.com/blog/eternalblue-nsa-developed-exploit-just-wont-die/>here</a>. So if you want to go the source there you go.</p><p>The enternalblue vulnerability takes advantage of three vulnerabilities in the programming of the SMB protocol. Furthermore, the vulnerability lies within the <code>srv!SrvOS2FeaListSizeToNt</code> Windows function. The first vulnerability is in a math error when casting a <code>OS/2 FileExtended Attribute (FEA)</code> list structure to a <code>NT FEA</code> structure which results in an integer overflow in the amount of memory that is allocated. The amount of memory that is allocated is small but enough not to cause the program to error. Because of less memory allocation, one can use it to perform a buffer overflow. Now this overflow would not be enough to get remote code execution (RCE) if it wasn&rsquo;t for the second vulnerability.</p><p>The second vulnerability lies within the <code>SMB_COM_TRANSACTION2</code> and <code>SMB_COM_NT_TRANSACT</code>sub-commands, where both have a secondary function in case a packet has too much data. The important thing about these two subcommands is that <code>TRANSACTION2</code> has calls for a packet size that is smaller than when using <code>NT_TRANSACT</code>. This is important as the smaller the packet size the easier it is to exploit the buffer overflow. Furthermore, there is error validation when using <code>NT_TRANSACT</code> before <code>TRANSACTION2</code> when sending a crafted message. The other interesting thing here too is that the program assigns the type and size of both packets based on the type of the last packet it has received.</p><p>But we are not done yet. We still need to get the RCE from the program and this can be done by using the third vulnerability. The third vulnerability allows for one to allocate a portion of memory at a given address, which could be at an address of a shell library embedded into the program, called heap spraying.</p><h3 id=events-leading-up>The Wild Events Leading Up</h3><p>So our story starts on Friday, April 15th, 2017 when a group known as &ldquo;Shadow Brokers&rdquo; released a large set of tools that were supposed to be NSA tools<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. These tools included many exploits that ranged from Windows devices, network devices, and Unix vulnerabilities<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. That being said, this toolset had significant impacts when released at the time. When this toolset was released troves of attackers flocked to exploit as many devices as possible<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. This even led to a famous ransomware outbreak known as the WannaCry ransomware which was supported by, you guessed it, the eternalblue vulnerability. The WannaCry virus was, again, a ransomware that affected many devices and had large impacts on the infrastructure of many organizations around the world.</p><p>Now Kaspersky had found that this Equation Group was a highly sophisticated hacking group as they were linked to the Stuxnet and Flame espionage malware<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>. Going through an exhaustive search Kaspersky went on to say that these attacks were caused by the NSA themselves. If this is truly the case, then this shows that the NSA was stockpiling exploits. Surprisingly, Microsoft had seemingly agreed with this train of thought from Kaspersky and posted on their site explaining why stockpiling these types of vulnerabilities can lead to big issues for end users <sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>.</p><p>Overall, there is some interesting evidence showing that government agencies, like the NSA, stockpile vulnerabilities. This brings into question the number of other tools that may still exist but are more well-hidden from the public. These events, and the subsequent tool set, surrounding the eternalblue vulnerability were found in 2017. Who&rsquo;s to say that other toolsets in the current time haven&rsquo;t already been created and are being actively used against whomever?</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://nvd.nist.gov/vuln/detail/CVE-2017-0144>https://nvd.nist.gov/vuln/detail/CVE-2017-0144</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.helpnetsecurity.com/2017/07/12/eternalblue-vulnerability-scanner-statistics/>https://www.helpnetsecurity.com/2017/07/12/eternalblue-vulnerability-scanner-statistics/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.rapid7.com/blog/post/2017/04/18/the-shadow-brokers-leaked-exploits-faq/>https://www.rapid7.com/blog/post/2017/04/18/the-shadow-brokers-leaked-exploits-faq/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.nopsec.com/blog/the-shadow-brokers-leaked-equation-groups-hacking-tools-a-lab-demo-analysis/>https://www.nopsec.com/blog/the-shadow-brokers-leaked-equation-groups-hacking-tools-a-lab-demo-analysis/</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://www.security.com/threat-intelligence/buckeye-windows-zero-day-exploit>https://www.security.com/threat-intelligence/buckeye-windows-zero-day-exploit</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://arstechnica.com/information-technology/2015/02/how-omnipotent-hackers-tied-to-the-nsa-hid-for-14-years-and-were-found-at-last/>https://arstechnica.com/information-technology/2015/02/how-omnipotent-hackers-tied-to-the-nsa-hid-for-14-years-and-were-found-at-last/</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://blogs.microsoft.com/on-the-issues/2017/05/14/need-urgent-collective-action-keep-people-safe-online-lessons-last-weeks-cyberattack/#sm.0000mpb068eggcqczh61fx32wtiui>https://blogs.microsoft.com/on-the-issues/2017/05/14/need-urgent-collective-action-keep-people-safe-online-lessons-last-weeks-cyberattack/#sm.0000mpb068eggcqczh61fx32wtiui</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>